---
title: "COVID analysis"
author: "Jon Yearsley"
date: "4/3/2020"
output: github_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/git_repos/corona/")

library(readxl)
library(ggplot2)
```


Data downloaded from https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports

```{r}
d = read_excel("COVID-19-geographic-disbtribution-worldwide.xlsx")
d$countriesAndTerritories = as.factor(d$countriesAndTerritories)
d$julian = as.numeric(julian(d$dateRep))
d$ID = c(1:nrow(d))

# Order deaths
ind = order(d$julian, d$countriesAndTerritories) 
d = d[ind,]

d$cumdeath = ave(d$deaths, 
                 d$countriesAndTerritories, 
                 FUN=function(x){cumsum(x)})
```


Find day when number of new cases exceeded 3
```{r}
dplus = subset(d, cases>100)
startDate = aggregate(julian~countriesAndTerritories + geoId + countryterritoryCode, 
                      data=dplus, 
                      FUN=function(x) {min(x)})

ind = match(dplus$countryterritoryCode,startDate$countryterritoryCode)
dplus$daysIn = dplus$julian - startDate$julian[ind]
```


Select data from some countries
```{r}
country = c('Ireland',
            'Italy',
            'Sweden',
            'United_Kingdom',
            'Framce', 
            'Germany')

d2 = subset(dplus, 
            countriesAndTerritories %in% country)
```

Plot the epidemic
```{r , echo=FALSE}
ggplot(data=d2,
       aes(x=daysIn, 
           y=cases, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1.5) +
  scale_y_log10() +
  scale_color_brewer(palette = 'Set1') +
  theme_bw() + 
  labs(x='Days post cases >100',
       y='Number of cases')
```

```{r message=FALSE, echo=FALSE}
ggplot(data=d2,
       aes(x=daysIn, 
           y=deaths, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1.5) +
  scale_y_log10() +
  scale_color_brewer(palette = 'Set1') +
  theme_bw() + 
  labs(x='Days post cases >100',
       y='Number of deaths')
```


```{r message=FALSE, echo=FALSE}
ggplot(data=d2,
       aes(x=cumdeath, 
           y=deaths, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1.5) +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_brewer(palette = 'Set1') +
  theme_bw() + 
  labs(x='Cumulative number of deaths',
       y='Number of deaths')
```



```{r message=FALSE, echo=FALSE}
ggplot(data=d2,
       aes(y=deaths/cases, 
           x=daysIn, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1.5) +
  scale_color_brewer(palette = 'Set1') +
  theme_bw() + 
  labs(x='Cumulative number of deaths',
       y='Number of deaths')
```
