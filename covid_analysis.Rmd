---
title: "COVID analysis"
author: "Jon Yearsley"
date: '`r format(Sys.Date(), " %d %B, %Y")`'
output: github_document
knit: (
  function(inputFile, encoding) { 

    pSubTitle <- 'README'

    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      params      = list(sub_title = pSubTitle),      
      output_file = pSubTitle) })
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#setwd("~/git_repos/corona/")

library(readxl)
library(ggplot2)
library(zoo)
#library(plotly)
```

A quick look at the European data on Covid-19.

Data downloaded from https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide.xlsx

## Process data
```{r}
download.file(url='https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide.xlsx',
              destfile='COVID-19-geographic-disbtribution-worldwide.xlsx')

d = read_excel("COVID-19-geographic-disbtribution-worldwide.xlsx")
d$countriesAndTerritories = as.factor(d$countriesAndTerritories)
d$julian = as.numeric(julian(d$dateRep))
d$ID = c(1:nrow(d))

# Order deaths by time
ind = order(d$julian, d$countriesAndTerritories) 
d = d[ind,]

d$cumdeaths = ave(d$deaths, 
                  d$countriesAndTerritories, 
                  FUN=function(x){cumsum(x)})
```


Find day when number of new cases exceeded X (where X is typically set at 100-300)
```{r}
casesThreshold = 100
casesStr = paste0('Days post ',casesThreshold,' cases') # String for graph labels
dplus = subset(d, cases>casesThreshold)
startDate = aggregate(julian~countriesAndTerritories + 
                        geoId + 
                        countryterritoryCode, 
                      data=dplus, 
                      FUN=function(x) {min(x)})

ind = match(dplus$countryterritoryCode,
            startDate$countryterritoryCode)
dplus$daysIn = dplus$julian - startDate$julian[ind]
```


Select data from some countries
```{r}
country = c('Ireland',
            'Sweden',
            'United_Kingdom',
            'France',
            'Denmark',
            'Austria',
            'Spain')

d2 = subset(dplus, 
            countriesAndTerritories %in% country)
```

Calculate rolling average over a window (nominally 7 days). One reason for doing this is because there's uncertainty in the dates due to the time it takes for deaths and cases to be registered, etc.
```{r}
dayWindow = 7
rollingStr = paste0('(',dayWindow,' day moving average)')  # String for graph labels
for (i in 1:length(country)) {
  tmp=subset(d2, countriesAndTerritories==country[i])
  tmp$deaths_rolling = rollmean(tmp$deaths, k=dayWindow, align='right', fill=NA)
  tmp$cumdeaths_rolling = rollmean(tmp$cumdeaths, k=dayWindow, align='right', fill=NA)
  tmp$cases_rolling = rollmean(tmp$cases, k=dayWindow, align='right', fill=NA)
  
  if (i==1) {
    d3 = tmp
  } else {
    d3 = rbind(d3, tmp)
  }
}
```


# Visualisations

### Tables of the latest new cases and deaths per country

```{r}
d_latest = subset(d3, julian==max(julian))

library(pander)
pander(d_latest[,c(7, 1,14,5,6,13)],
       col.names=c('Country',
                   'Date',
                   paste('Days post\n',casesThreshold,'cases'),
                   'New \nCases',
                   'New \nDeaths',
                   'Total deaths'),
       caption='Table 1: The latest numbers from the European Centre for Diesease Prevention and Control (ECDPC). https://www.ecdc.europa.eu/en',
       keep.line.breaks = TRUE)
```


### Temporal trends

```{r , echo=FALSE}
p1 = ggplot(data=d3,
       aes(x=daysIn, 
           y=cases_rolling, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1,
              se=FALSE) +
  scale_y_log10() +
  scale_color_brewer(palette = 'Dark2') +
  theme_bw() + 
  labs(x=casesStr,
       y=paste('Number of cases',rollingStr),
       title='Trend in new cases')

#ggplotly(p1)

p1
```

```{r message=FALSE, echo=FALSE}
p2=ggplot(data=d3,
       aes(x=daysIn, 
           y=deaths_rolling, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1,
              se=FALSE) +
  scale_y_log10() +
  scale_color_brewer(palette = 'Dark2') +
  theme_bw() + 
  labs(x=casesStr,
       y=paste('Number of deaths',rollingStr),
       title='Trend in deaths')

#ggplotly(p2)
p2
```

```{r message=FALSE, echo=FALSE}
p3 = ggplot(data=d3,
       aes(y=deaths_rolling/cases_rolling, 
           x=daysIn, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1,
              se=FALSE) +
  scale_color_brewer(palette = 'Dark2') +
  theme_bw() + 
  labs(y=paste('Deaths / Cases',rollingStr),
       x=casesStr,
       title='Crude death rate trend')

#ggplotly(p3)
p3
```

### Epidemic indicator

```{r message=FALSE, echo=FALSE}
p4 = ggplot(data=d3,
       aes(x=cumdeaths_rolling, 
           y=deaths_rolling, 
           colour=countriesAndTerritories)) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1,
              se=FALSE) +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_brewer(palette = 'Dark2') +
  theme_bw() + 
  labs(x=paste0('Cumulative number of deaths ',rollingStr),
       y=paste0('Number of deaths ',rollingStr),
       title='Cumulative verus current deaths')

#ggplotly(p4)
p4
```

Fit a linear trend and plot residuals

```{r}
m = lm(log10(deaths_rolling)~(1+log10(cumdeaths_rolling))*countriesAndTerritories, 
       data=d3, 
       na.action=na.exclude)
```

Plot residuals from these linear trends
```{r}
d3$residuals = residuals(m)
d3$fitted = fitted(m)

p5 = ggplot(data=d3,
       aes(x=fitted, 
           y=residuals, 
           colour=countriesAndTerritories)) +
  geom_abline(intercept=0, slope=0) +
  geom_point() + 
  geom_smooth(method = 'loess', 
              span=1,
              se=FALSE) +
  scale_color_brewer(palette = 'Dark2') +
  theme_bw() + 
  labs(x=paste0('Fitted for log10(number of deaths)'),
       y=paste0('Residuals from linear regression'),
       title='Residuals from cumulative verus current deaths')

#ggplotly(p5)
p5
```


